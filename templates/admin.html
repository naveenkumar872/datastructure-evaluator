<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Data Structure Evaluator - Admin Dashboard</title>
    <link rel="stylesheet" href="/static/css/styles.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

</head>

<body>
    <script>
        // Check if the user is authenticated and is admin
        fetch('/admin-check')
            .then((response) => {
                if (!response.ok) {
                    window.location.href = '/login.html';
                }
            })
            .catch(() => {
                window.location.href = '/login.html';
            });
    </script>

    <header class="topbar">
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
            </svg>
            Data Structure Evaluator Admin
        </div>
        <div class="role" style="display: flex; align-items: center; gap: 12px;">
            <button id="btn-upload-question" class="btn primary" onclick="window.location.href='/questions.html'"
                style="height: 40px; display: flex; align-items: center; gap: 8px; padding: 0 16px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12" />
                </svg>
                Upload Question
            </button>

            <div class="user-badge"
                style="height: 40px; padding: 0 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; display: flex; align-items: center; gap: 8px;">
                <div class="avatar"
                    style="width: 24px; height: 24px; font-size: 12px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                    A</div>
                <span style="font-weight: 500; font-size: 0.9rem; color: #334155;">Administrator</span>
            </div>

            <button id="btn-settings" class="btn secondary"
                style="height: 40px; padding: 0 16px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; display: flex; align-items: center; gap: 8px; color: #475569;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z">
                    </path>
                </svg>
                Settings
            </button>

            <button class="btn secondary" onclick="toggleTheme()" title="Toggle Theme"
                style="height: 40px; padding: 0 16px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
                <svg id="icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
                <svg id="icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" style="display:none;">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
            </button>

            <button id="btn-logout" class="btn secondary"
                style="height: 40px; padding: 0 16px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Log Out
            </button>
        </div>
    </header>

    <main class="admin-container">
        <!-- Dashboard Header -->
        <div class="dashboard-header"
            style="display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 16px;">
            <div>
                <h1 style="display: flex; align-items: center; gap: 8px;">
                    Welcome back, <span id="admin-name-display">Admin</span> üëã
                </h1>
                <p>Here's an overview of student performance and recent submissions.</p>
            </div>
            <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <button class="btn primary" id="btn-send-report">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="margin-right: 6px;">
                        <path d="M22 2L11 13" />
                        <path d="M22 2l-7 20-4-9-9-4 20-7z" />
                    </svg>
                    Send Reports
                </button>
                <button class="btn danger" id="btn-reset-submissions">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="margin-right: 6px;">
                        <path d="M4 4v5h.582M19.418 19.418A9 9 0 1 1 21 12" />
                    </svg>
                    Reset All Submissions
                </button>
                <span id="reset-msg" style="margin-left: 8px; color: #dc2626; font-weight: 500;"></span>
            </div>
        </div>


        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-value" id="total-submissions">0</div>
                <div class="stat-label">Total Submissions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-students">0</div>
                <div class="stat-label">Total Students</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="accepted-count">0</div>
                <div class="stat-label">Accepted Solutions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="rejected-count">0</div>
                <div class="stat-label">Rejected Solutions</div>
            </div>
        </div>



        <!-- Main Content Grid -->
        <div class="container" style="padding: 0; max-width: none;">
            <!-- Student List Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                                <circle cx="9" cy="7" r="4" />
                                <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75" />
                            </svg> Students <span id="sidebar-student-count"
                                style="font-size: 0.9em; opacity: 0.8; margin-left: 5px;"></span></h3>
                    </div>
                    <ul id="student-list" class="student-list"
                        style="max-height: calc(100vh - 250px); overflow-y: auto; padding-right: 4px;">
                        <!-- Students will be loaded here -->
                    </ul>
                </div>
            </aside>

            <!-- Submissions Table -->
            <section class="content">
                <div class="panel">
                    <div class="panel-header">
                        <div>
                            <div class="panel-title" id="submissions-title">All Submissions</div>
                            <div class="panel-subtitle" id="submissions-subtitle">Click on a student to filter their
                                submissions</div>
                        </div>
                        <button class="btn secondary" onclick="window.location.href='/analytics'"
                            style="margin-right: 10px; border-color: #6366f1; color: #6366f1;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" style="margin-right: 6px;">
                                <path d="M18 20V10M12 20V4M6 20v-6" />
                            </svg>
                            Live Analytics
                        </button>
                        <button class="btn secondary" id="btn-export-csv"
                            onclick="window.location.href='/api/admin/export-submissions'" style="margin-right: 10px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" style="margin-right: 6px;">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
                                <polyline points="7 10 12 15 17 10" />
                                <line x1="12" y1="15" x2="12" y2="3" />
                            </svg>
                            Export Submissions
                        </button>
                        <button class="btn primary" id="btn-show-all">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" style="margin-right: 6px;">
                                <path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z" />
                            </svg>
                            All Student Submissions
                        </button>
                    </div>

                    <div class="table-wrapper" style="max-height: calc(100vh - 250px); overflow-y: auto;">
                        <table class="data-table">
                            <thead style="position: sticky; top: 0; background: var(--bg-primary); z-index: 10;">
                                <tr>
                                    <th>Student</th>
                                    <th>Problem</th>
                                    <th>File</th>
                                    <th>Status</th>
                                    <th>Score</th>
                                    <th>Submitted</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="submissions-table">
                                <!-- Submissions will be loaded here -->
                            </tbody>
                        </table>

                        <div id="no-submissions" class="hidden" style="padding: 60px 20px; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 20px;">üì≠</div>
                            <h3 style="margin-bottom: 10px; color: var(--text-primary);">No Submissions Found</h3>
                            <p style="color: var(--text-muted);">There are no student submissions to display at the
                                moment.</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Submission Detail Modal -->
    <div id="detail-modal" class="modal hidden">
        <div class="modal-card" style="max-width: 800px;">
            <div class="modal-header">
                <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="vertical-align: middle; margin-right: 6px;">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                        <polyline points="10 9 9 9 8 9" />
                    </svg>Submission Details</h3>
                <button class="modal-close" id="close-modal">&times;</button>
            </div>

            <div id="modal-content">
                <!-- Submission Info -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div>
                        <div class="form-label">Student</div>
                        <div id="detail-student" style="font-weight: 600; color: var(--text-primary);"></div>
                    </div>
                    <div>
                        <div class="form-label">Problem</div>
                        <div id="detail-problem" style="font-weight: 600; color: var(--text-primary);"></div>
                    </div>
                    <div>
                        <div class="form-label">Status</div>
                        <div id="detail-status"></div>
                    </div>
                    <div>
                        <div class="form-label">Score</div>
                        <div id="detail-score" style="font-weight: 600; font-size: 1.25rem;"></div>
                    </div>
                </div>

                <!-- AI Detection & Similarity Stats -->
                <div
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                    <div>
                        <div class="form-label" style="display: flex; align-items: center; gap: 6px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z" />
                                <path d="M12 6v6l4 2" />
                            </svg>
                            AI Detection
                        </div>
                        <div id="detail-ai-score" style="font-weight: 600; font-size: 1.1rem;"></div>
                    </div>
                    <div>
                        <div class="form-label" style="display: flex; align-items: center; gap: 6px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                                <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
                            </svg>
                            Similar Submissions
                            <button id="btn-view-similar" class="btn secondary"
                                style="padding: 2px 8px; font-size: 11px; margin-left: auto;"
                                title="View students with similar code">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <circle cx="12" cy="12" r="10" />
                                    <line x1="12" y1="16" x2="12" y2="12" />
                                    <line x1="12" y1="8" x2="12.01" y2="8" />
                                </svg>
                                View
                            </button>
                        </div>
                        <div id="detail-similarity" style="font-weight: 600; font-size: 1.1rem;"></div>
                    </div>
                </div>

                <!-- Similar Students Modal (hidden by default) -->
                <div id="similar-students-panel"
                    style="display: none; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <div
                        style="font-weight: 600; color: #92400e; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                            <line x1="12" y1="9" x2="12" y2="13" />
                            <line x1="12" y1="17" x2="12.01" y2="17" />
                        </svg>
                        Students with Similar Code
                    </div>
                    <div id="similar-students-list" style="max-height: 150px; overflow-y: auto;"></div>
                </div>

                <!-- Code Preview -->
                <div style="margin-bottom: 20px;">
                    <div class="form-label" style="margin-bottom: 8px;">Submitted Code</div>
                    <pre class="code-preview" id="detail-code"></pre>
                </div>

                <!-- Evaluation Report -->
                <div class="evaluation-report">
                    <h4><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                            <path d="M7 11V7a5 5 0 0110 0v4" />
                        </svg>AI Evaluation Report</h4>
                    <div class="evaluation-content" id="detail-evaluation"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Send Reports Modal -->
    <div id="send-reports-modal" class="modal hidden">
        <div class="modal-card" style="max-width: 500px;">
            <div class="modal-header">
                <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="vertical-align: middle; margin-right: 6px;">
                        <rect x="2" y="4" width="20" height="16" rx="2" />
                        <path d="M22 6l-10 7L2 6" />
                    </svg>Send Reports to Students</h3>
                <button class="modal-close" id="close-send-modal">&times;</button>
            </div>

            <div id="send-modal-content" style="padding: 20px;">
                <p style="color: var(--text-muted); margin-bottom: 20px;">Send submission reports to students via email.
                    Choose a time range to filter submissions.</p>

                <!-- Time Range Selection -->
                <div style="margin-bottom: 24px;">
                    <div class="form-label" style="margin-bottom: 12px;">Select Time Range</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="time-range-btn" data-range="1h"
                            style="padding: 12px; border: 2px solid var(--border); border-radius: 8px; background: white; cursor: pointer; font-size: 14px; transition: all 0.2s;">Last
                            1 Hour</button>
                        <button class="time-range-btn" data-range="2h"
                            style="padding: 12px; border: 2px solid var(--border); border-radius: 8px; background: white; cursor: pointer; font-size: 14px; transition: all 0.2s;">Last
                            2 Hours</button>
                        <button class="time-range-btn active" data-range="5h"
                            style="padding: 12px; border: 2px solid var(--primary); border-radius: 8px; background: var(--primary); color: white; cursor: pointer; font-size: 14px; transition: all 0.2s;">Last
                            5 Hours</button>
                        <button class="time-range-btn" data-range="12h"
                            style="padding: 12px; border: 2px solid var(--border); border-radius: 8px; background: white; cursor: pointer; font-size: 14px; transition: all 0.2s;">Last
                            12 Hours</button>
                        <button class="time-range-btn" data-range="24h"
                            style="padding: 12px; border: 2px solid var(--border); border-radius: 8px; background: white; cursor: pointer; font-size: 14px; transition: all 0.2s;">Last
                            24 Hours</button>
                        <button class="time-range-btn" data-range="48h"
                            style="padding: 12px; border: 2px solid var(--border); border-radius: 8px; background: white; cursor: pointer; font-size: 14px; transition: all 0.2s;">Last
                            48 Hours</button>
                    </div>
                </div>

                <!-- Preview Section -->
                <div style="margin-bottom: 20px;">
                    <div class="form-label" style="margin-bottom: 12px;">Preview</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                        <div
                            style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                            <div id="preview-total-submissions"
                                style="font-size: 28px; font-weight: 700; color: var(--primary);">0</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Submissions</div>
                        </div>
                        <div
                            style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                            <div id="preview-with-email" style="font-size: 28px; font-weight: 700; color: #22c55e;">0
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted);">With Email</div>
                        </div>
                        <div
                            style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                            <div id="preview-without-email" style="font-size: 28px; font-weight: 700; color: #f59e0b;">0
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted);">No Email</div>
                        </div>
                    </div>
                    <p id="preview-summary" style="font-size: 14px; color: var(--text-muted);">Reports will be sent to
                        <strong id="preview-send-count">0</strong> student(s) with valid email addresses.
                    </p>
                </div>

                <!-- Send Button -->
                <button class="btn primary" id="btn-confirm-send" style="width: 100%; padding: 14px; font-size: 15px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="margin-right: 8px;">
                        <path d="M22 2L11 13" />
                        <path d="M22 2l-7 20-4-9-9-4 20-7z" />
                    </svg>
                    Send Reports
                </button>

                <!-- Results (shown after sending) -->
                <div id="send-results" style="display: none; margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        // Selected time range for sending reports
        let selectedTimeRange = '5h';

        // Load preview for selected time range
        async function loadSendPreview(timeRange) {
            selectedTimeRange = timeRange;

            // Update button styles
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                if (btn.dataset.range === timeRange) {
                    btn.style.border = '2px solid var(--primary)';
                    btn.style.background = 'var(--primary)';
                    btn.style.color = 'white';
                } else {
                    btn.style.border = '2px solid var(--border)';
                    btn.style.background = 'white';
                    btn.style.color = 'inherit';
                }
            });

            try {
                const res = await fetch('/api/admin/send-reports/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timeRange })
                });

                if (!res.ok) throw new Error('Failed to load preview');

                const data = await res.json();

                // Update stats
                document.getElementById('preview-total-submissions').textContent = data.total_submissions;
                document.getElementById('preview-with-email').textContent = data.with_email;
                document.getElementById('preview-without-email').textContent = data.without_email;
                document.getElementById('preview-send-count').textContent = data.with_email;
            } catch (err) {
                console.error('Error loading preview:', err);
            }
        }

        // Send Reports button handler - opens modal
        document.getElementById('btn-send-report').onclick = function () {
            // Reset results
            document.getElementById('send-results').style.display = 'none';
            document.getElementById('btn-confirm-send').style.display = 'flex';
            document.getElementById('btn-confirm-send').disabled = false;
            document.getElementById('btn-confirm-send').innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg> Send Reports';

            // Show modal
            document.getElementById('send-reports-modal').classList.remove('hidden');

            // Load preview for default time range
            loadSendPreview(selectedTimeRange);
        };

        // Time range button click handlers
        document.querySelectorAll('.time-range-btn').forEach(btn => {
            btn.onclick = function () {
                loadSendPreview(this.dataset.range);
            };
        });

        // Close send reports modal
        document.getElementById('close-send-modal').onclick = function () {
            document.getElementById('send-reports-modal').classList.add('hidden');
        };
        document.getElementById('send-reports-modal').onclick = function (e) {
            if (e.target === this) this.classList.add('hidden');
        };

        // Confirm send reports
        document.getElementById('btn-confirm-send').onclick = async function () {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Sending emails...';

            try {
                const res = await fetch('/api/admin/send-reports', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timeRange: selectedTimeRange })
                });

                const data = await res.json();

                // Show results
                const resultsDiv = document.getElementById('send-results');
                if (data.success) {
                    resultsDiv.innerHTML = `
                        <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-weight: 600; color: #166534; margin-bottom: 10px;">‚úÖ Reports Sent Successfully</div>
                            <div style="display: flex; gap: 20px; font-size: 14px; justify-content: center;">
                                <span><strong>${data.sent}</strong> sent</span>
                                <span><strong>${data.failed}</strong> failed</span>
                                <span><strong>${data.skipped}</strong> skipped</span>
                            </div>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-weight: 600; color: #991b1b;">‚ùå Error</div>
                            <div style="font-size: 14px; color: #991b1b;">${data.message || 'Failed to send reports'}</div>
                        </div>
                    `;
                }
                resultsDiv.style.display = 'block';
                btn.style.display = 'none';
            } catch (err) {
                console.error('Error sending reports:', err);
                alert('Failed to send reports. Please try again.');
                btn.disabled = false;
                btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg> Send Reports';
            }
        };

        // Reset submissions handler (admin only)
        document.getElementById('btn-reset-submissions').onclick = async function () {
            if (!confirm('Are you sure you want to delete ALL submissions? This cannot be undone.')) return;
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'Resetting...';
            document.getElementById('reset-msg').textContent = '';
            try {
                const res = await fetch('/api/admin/reset-submissions', { method: 'POST' });
                if (res.ok) {
                    document.getElementById('reset-msg').textContent = 'All submissions have been reset.';
                    loadDashboard();
                } else {
                    document.getElementById('reset-msg').textContent = 'Failed to reset submissions.';
                }
            } catch (err) {
                document.getElementById('reset-msg').textContent = 'Error connecting to server.';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path d="M4 4v5h.582M19.418 19.418A9 9 0 1 1 21 12" /></svg> Reset All Submissions';
            }
        };
        // Logout handler
        document.getElementById('btn-logout').onclick = function () {
            fetch('/logout').then(() => {
                window.location.href = '/login.html';
            });
        };

        // Close modal
        document.getElementById('close-modal').onclick = function () {
            document.getElementById('detail-modal').classList.add('hidden');
        };

        // Click outside modal to close
        document.getElementById('detail-modal').onclick = function (e) {
            if (e.target === this) {
                this.classList.add('hidden');
            }
        };

        // Load dashboard data
        async function loadDashboard() {
            // Fetch Admin Name
            fetch('/get-user-info').then(res => res.json()).then(data => {
                const nameEl = document.getElementById('admin-name-display');
                if (data.username && nameEl) nameEl.textContent = data.username;
            }).catch(() => { });

            try {
                // Load students
                const studentsRes = await fetch('/api/admin/students');
                const students = await studentsRes.json();

                document.getElementById('total-students').textContent = students.length;
                document.getElementById('sidebar-student-count').textContent = `(${students.length})`;

                const studentList = document.getElementById('student-list');
                studentList.innerHTML = students.map(s => `
          <li class="student-item" data-username="${s.register_no}">
            <div class="student-info">
              <div class="student-avatar">${s.username.charAt(0).toUpperCase()}</div>
              <div>
                <div class="student-name">${s.username}</div>
                <div class="student-meta">${s.register_no || ''}</div>
              </div>
            </div>
          </li>
        `).join('');

                // Add click handlers to students
                document.querySelectorAll('.student-item').forEach(item => {
                    item.onclick = function () {
                        // We still filter by the actual username (reg no)
                        const username = this.dataset.username;
                        loadSubmissions(username);
                    };
                });

                // Load all submissions
                loadSubmissions();
            } catch (err) {
                console.error('Error loading dashboard:', err);
            }
        }

        // Load submissions (optionally filtered by username)
        async function loadSubmissions(username = null) {
            try {
                // IMPORTANT: The backend 'username' parameter expects the register number!
                // But the 'username' variable here might be coming from a click, which is the reg no.
                const url = username
                    ? `/api/admin/submissions?username=${encodeURIComponent(username)}`
                    : '/api/admin/submissions';

                const res = await fetch(url);
                const submissions = await res.json();

                // Update title
                if (username) {
                    // Find name if possible, or just show reg no
                    document.getElementById('submissions-title').textContent = `${username}'s Submissions`;
                    document.getElementById('submissions-subtitle').textContent = `Showing ${submissions.length} submission(s)`;
                } else {
                    document.getElementById('submissions-title').textContent = 'All Submissions';
                    document.getElementById('submissions-subtitle').textContent = `Showing ${submissions.length} total submission(s)`;
                }

                // Update stats
                document.getElementById('total-submissions').textContent = submissions.length;
                const accepted = submissions.filter(s => s.status === 'accepted').length;
                const rejected = submissions.filter(s => s.status === 'rejected').length;
                document.getElementById('accepted-count').textContent = accepted;
                document.getElementById('rejected-count').textContent = rejected;

                // Render table
                const tbody = document.getElementById('submissions-table');
                const noSubmissions = document.getElementById('no-submissions');

                if (submissions.length === 0) {
                    tbody.innerHTML = '';
                    noSubmissions.classList.remove('hidden');
                } else {
                    noSubmissions.classList.add('hidden');
                    tbody.innerHTML = submissions.map(s => `
            <tr>
              <td class="student-name">
                <div>${s.username}</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); font-weight: normal;">${s.register_no || ''}</div>
              </td>
              <td>${s.problem_title || 'N/A'}</td>
              <td>${s.filename}</td>
              <td>
                <span class="status-badge ${s.status === 'accepted' ? 'success' : 'failed'}">
                  ${s.status === 'accepted' ? '‚úì Accepted' : '‚úó Rejected'}
                </span>
              </td>
              <td>${s.score || 0}/100</td>
              <td>${formatDate(s.submitted_at)}</td>
              <td>
                <button class="btn secondary action-btn" onclick="viewSubmission(${s.id})">
                  View Report
                </button>
              </td>
            </tr>
          `).join('');
                }



            } catch (err) {
                console.error('Error loading submissions:', err);
            }
        }



        // Store current submission ID for similarity lookup
        let currentSubmissionId = null;

        // View submission detail
        async function viewSubmission(id) {
            try {
                currentSubmissionId = id;
                const res = await fetch(`/api/admin/submission/${id}`);
                const sub = await res.json();

                document.getElementById('detail-student').textContent = sub.username;
                document.getElementById('detail-problem').textContent = sub.problem_title || 'N/A';
                document.getElementById('detail-status').innerHTML = `
                        < span class="status-badge ${sub.status === 'accepted' ? 'success' : 'failed'}" >
                            ${sub.status === 'accepted' ? '‚úì Accepted' : '‚úó Rejected'}
          </span >
                        `;
                document.getElementById('detail-score').textContent = `${sub.score || 0}/100`;

                // AI Detection Score
                const aiScore = sub.ai_score || 0;
                const aiColor = aiScore >= 60 ? '#dc2626' : aiScore >= 40 ? '#f59e0b' : '#22c55e';
                const aiLabel = aiScore >= 60 ? 'Likely AI' : aiScore >= 40 ? 'Uncertain' : 'Likely Human';
                document.getElementById('detail-ai-score').innerHTML = `
                    <span style="color: ${aiColor};">${aiScore}%</span>
                    <span style="font-size: 12px; color: var(--text-muted); margin-left: 8px;">${aiLabel}</span>
                `;

                // Reset similarity panel
                document.getElementById('detail-similarity').innerHTML = '<span style="color: var(--text-muted);">Click View to check</span>';
                document.getElementById('similar-students-panel').style.display = 'none';

                document.getElementById('detail-code').textContent = sub.file_content || 'No code available';
                document.getElementById('detail-evaluation').innerHTML = formatEvaluation(sub.evaluation || 'No evaluation available');

                document.getElementById('detail-modal').classList.remove('hidden');
            } catch (err) {
                console.error('Error loading submission:', err);
                alert('Failed to load submission details');
            }
        }

        // View similar submissions button handler
        document.getElementById('btn-view-similar').onclick = async function () {
            if (!currentSubmissionId) return;

            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '‚è≥';

            try {
                const res = await fetch(`/api/admin/submission/${currentSubmissionId}/similar`);
                const similar = await res.json();

                const similarityDiv = document.getElementById('detail-similarity');
                const panelDiv = document.getElementById('similar-students-panel');
                const listDiv = document.getElementById('similar-students-list');

                if (similar.length === 0) {
                    similarityDiv.innerHTML = '<span style="color: #22c55e;">‚úì No similar code found</span>';
                    panelDiv.style.display = 'none';
                } else {
                    const maxSim = similar[0].similarity;
                    const simColor = maxSim >= 90 ? '#dc2626' : maxSim >= 70 ? '#f59e0b' : '#22c55e';
                    similarityDiv.innerHTML = `<span style="color: ${simColor};">${similar.length} match${similar.length > 1 ? 'es' : ''} (up to ${maxSim}%)</span>`;

                    listDiv.innerHTML = similar.map(s => `
                        <div style="padding: 8px; background: white; border-radius: 4px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${s.name}</strong>
                                <span style="color: var(--text-muted); font-size: 12px; margin-left: 8px;">${s.username}</span>
                            </div>
                            <div style="font-weight: 600; color: ${s.similarity >= 90 ? '#dc2626' : '#f59e0b'};">
                                ${s.similarity}% match
                            </div>
                        </div>
                    `).join('');

                    panelDiv.style.display = 'block';
                }
            } catch (err) {
                console.error('Error checking similarity:', err);
                document.getElementById('detail-similarity').innerHTML = '<span style="color: #dc2626;">Error checking</span>';
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg> View`;
            }
        };

        // Show all submissions
        document.getElementById('btn-show-all').onclick = function () {
            loadSubmissions();
        };

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Format evaluation text to HTML
        function formatEvaluation(text) {
            if (!text) return 'No evaluation available';
            // Convert **bold** to <strong>
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--primary);">$1</strong>');
            // Convert headers
            text = text.replace(/^## (.*)$/gm, '<h4 style="color: var(--text-primary); margin: 16px 0 8px 0;">$1</h4>');
            text = text.replace(/^### (.*)$/gm, '<h5 style="color: var(--text-secondary); margin: 12px 0 6px 0;">$1</h5>');
            // Convert bullet points
            text = text.replace(/^- (.*)$/gm, '<div style="padding-left: 16px; margin: 4px 0;">‚Ä¢ $1</div>');
            // Highlight scores
            text = text.replace(/(\d+)\/100/g, '<span style="color: var(--success); font-weight: 600;">$1/100</span>');
            // Highlight PASS/FAIL
            text = text.replace(/\bPASS\b/g, '<span class="status-badge success">‚úì PASS</span>');
            text = text.replace(/\bFAIL\b/g, '<span class="status-badge failed">‚úó FAIL</span>');
            return text;
        }

        // =============================================
        // Question Management Functions
        // =============================================


        // Initialize
        loadDashboard();

        // Settings Modal Handlers
        document.addEventListener('DOMContentLoaded', () => {
            const settingsModal = document.getElementById('settings-modal');
            const customExtInput = document.getElementById('settings-ext-custom');
            const extCheckboxes = document.querySelectorAll('.ext-check');

            const btnSettings = document.getElementById('btn-settings');
            if (btnSettings) {
                btnSettings.onclick = async function () {
                    settingsModal.classList.remove('hidden');
                    // Load current settings
                    try {
                        const res = await fetch('/api/config/extensions');
                        const data = await res.json();
                        const currentExts = data.extensions.split(',').map(e => e.trim());

                        const common = ['c', 'cpp', 'java', 'py', 'txt'];
                        const custom = [];

                        // Update checkboxes
                        extCheckboxes.forEach(cb => {
                            cb.checked = currentExts.includes(cb.value);
                        });

                        // Find custom ones
                        currentExts.forEach(e => {
                            if (e && !common.includes(e)) custom.push(e);
                        });
                        customExtInput.value = custom.join(', ');

                        // Load General Config
                        const confRes = await fetch('/api/public/config');
                        const conf = await confRes.json();
                        document.getElementById('check-block-paste').checked = conf.block_paste;
                        document.getElementById('check-enable-editor').checked = conf.enable_editor;
                        document.getElementById('check-enable-upload').checked = conf.enable_upload;

                    } catch (e) { console.error(e); }
                };
            }

            const closeBtn = document.getElementById('close-settings-modal');
            if (closeBtn) {
                closeBtn.onclick = function () {
                    settingsModal.classList.add('hidden');
                };
            }

            const saveBtn = document.getElementById('btn-save-settings');
            if (saveBtn) {
                saveBtn.onclick = async function () {
                    const btn = this;
                    const msg = document.getElementById('settings-msg');

                    btn.disabled = true;
                    btn.textContent = 'Saving...';
                    msg.textContent = '';
                    msg.className = '';

                    const selected = Array.from(extCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
                    const custom = customExtInput.value.split(',').map(e => e.trim()).filter(e => e);
                    const all = [...new Set([...selected, ...custom])].join(','); // unique

                    try {
                        // Save General Config
                        await fetch('/api/admin/config/general', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                block_paste: document.getElementById('check-block-paste').checked,
                                enable_editor: document.getElementById('check-enable-editor').checked,
                                enable_upload: document.getElementById('check-enable-upload').checked
                            })
                        });

                        const res = await fetch('/api/admin/config/extensions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ extensions: all })
                        });
                        const data = await res.json();
                        if (data.success) {
                            // Inline success message
                            msg.textContent = '‚úì Settings saved successfully!';
                            msg.style.color = '#10b981';
                            setTimeout(() => {
                                settingsModal.classList.add('hidden');
                                msg.textContent = '';
                            }, 1500);
                        } else {
                            msg.textContent = 'Error: ' + data.message;
                            msg.style.color = '#ef4444';
                        }
                    } catch (e) {
                        msg.textContent = 'Connection error';
                        msg.style.color = '#ef4444';
                    } finally {
                        btn.disabled = false;
                        btn.textContent = 'Save Changes';
                    }
                };
            }
        });
    </script>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal hidden">
        <div class="modal-card" style="max-width: 650px;">
            <div class="modal-header">
                <h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="vertical-align: middle; margin-right: 8px;">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z">
                        </path>
                    </svg>System Settings</h3>
                <button class="modal-close" id="close-settings-modal">&times;</button>
            </div>
            <div style="padding: 24px;">
                <h4 style="margin-bottom: 12px; color: var(--text-primary); font-size: 1.1rem;">Student Portal Features
                </h4>
                <div
                    style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border-color);">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                        <span style="font-weight: 500;">Block Copy/Paste (Anti-Cheat)</span>
                        <label class="switch">
                            <input type="checkbox" id="check-block-paste">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                        <span style="font-weight: 500;">Enable Code Editor</span>
                        <label class="switch">
                            <input type="checkbox" id="check-enable-editor">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                        <span style="font-weight: 500;">Enable File Upload</span>
                        <label class="switch">
                            <input type="checkbox" id="check-enable-upload">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <h4 style="margin-bottom: 12px; color: var(--text-primary); font-size: 1.1rem;">Allowed File Extensions
                </h4>
                <p style="margin-bottom: 20px; color: var(--text-muted); font-size: 0.95rem;">Select accepted file types
                    for student submissions.</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                    <label
                        style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: var(--bg-tertiary); border-radius: 8px;">
                        <input type="checkbox" class="ext-check" value="c" style="width: 18px; height: 18px;">
                        <span style="font-weight: 500;">.c (C Source)</span>
                    </label>
                    <label
                        style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: var(--bg-tertiary); border-radius: 8px;">
                        <input type="checkbox" class="ext-check" value="cpp" style="width: 18px; height: 18px;">
                        <span style="font-weight: 500;">.cpp (C++ Source)</span>
                    </label>
                    <label
                        style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: var(--bg-tertiary); border-radius: 8px;">
                        <input type="checkbox" class="ext-check" value="java" style="width: 18px; height: 18px;">
                        <span style="font-weight: 500;">.java (Java Source)</span>
                    </label>
                    <label
                        style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: var(--bg-tertiary); border-radius: 8px;">
                        <input type="checkbox" class="ext-check" value="py" style="width: 18px; height: 18px;">
                        <span style="font-weight: 500;">.py (Python Script)</span>
                    </label>
                    <label
                        style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: var(--bg-tertiary); border-radius: 8px;">
                        <input type="checkbox" class="ext-check" value="txt" style="width: 18px; height: 18px;">
                        <span style="font-weight: 500;">.txt (Text File)</span>
                    </label>
                </div>

                <div style="margin-bottom: 24px;">
                    <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">Custom
                        Extensions (comma separated)</label>
                    <input type="text" id="settings-ext-custom" class="form-input" placeholder="e.g. js, rs, go"
                        style="padding: 12px;">
                </div>

                <button class="btn primary" id="btn-save-settings"
                    style="width: 100%; padding: 14px; font-size: 1rem;">Save Changes</button>
                <div id="settings-msg"
                    style="margin-top: 16px; text-align: center; min-height: 24px; font-weight: 500;"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // Theme Manager
        // ============================================
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Defer icon update until DOM loaded (or call immediately if safe)
        if (document.body) updateThemeIcon(savedTheme);
        else document.addEventListener('DOMContentLoaded', () => updateThemeIcon(savedTheme));

        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const moon = document.getElementById('icon-moon');
            const sun = document.getElementById('icon-sun');
            if (!moon || !sun) return;

            if (theme === 'dark') {
                moon.style.display = 'none';
                sun.style.display = 'block';
            } else {
                moon.style.display = 'block';
                sun.style.display = 'none';
            }
        }
    </script>
</body>