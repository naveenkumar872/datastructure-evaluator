<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Data Structure Evaluator - Student Portal</title>
  <link rel="stylesheet" href="/static/css/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Monaco Editor Loader -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
  <style>
    /* Monaco Editor Integration Styles */
    .submission-toggle {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      padding: 4px;
      background: #f1f5f9;
      width: fit-content;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
    }

    .toggle-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 8px;
      font-weight: 500;
      color: #64748b;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .toggle-btn:hover {
      color: #1e293b;
      background: rgba(255, 255, 255, 0.5);
    }

    .toggle-btn.active {
      background: white;
      color: #6366f1;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      font-weight: 600;
    }

    .monaco-wrapper {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      height: 400px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .editor-container-box {
      display: none;
    }

    .editor-container-box.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <script>
    // Check if the user is authenticated
    fetch('/auth-check')
      .then((response) => {
        if (!response.ok) {
          window.location.href = '/login.html';
        }
      })
      .catch(() => {
        window.location.href = '/login.html';
      });

    // ============================================
    // Global Config & Feature Flags
    // ============================================
    window.appConfig = { block_paste: false, enable_editor: true, enable_upload: true };

    async function loadConfig() {
      try {
        const res = await fetch('/api/public/config');
        const conf = await res.json();
        window.appConfig = conf;

        // Apply UI Visibility Rules
        if (!conf.enable_editor) {
          // Hide 'Code Editor' toggle buttons
          const styles = document.createElement('style');
          styles.innerHTML = `button[onclick*="'editor'"] { display: none !important; }`;
          document.head.appendChild(styles);
        }

        if (!conf.enable_upload) {
          // Hide 'Upload File' toggle buttons
          const styles = document.createElement('style');
          styles.innerHTML = `button[onclick*="'upload'"] { display: none !important; }`;
          document.head.appendChild(styles);

          // If Upload is disabled but Editor enabled, force Editor mode on load
          if (conf.enable_editor) {
            // We wait a bit for DOM
            setTimeout(() => {
              for (let i = 1; i <= 10; i++) switchMode(i, 'editor');
            }, 500);
          }
        }

      } catch (e) { console.error("Config load failed", e); }
    }
    loadConfig();
  </script>

  <header class="topbar">
    <div class="brand">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
      </svg>
      Data Structure Evaluator
    </div>
    <div class="role">
      <button class="btn secondary" onclick="toggleTheme()" title="Toggle Theme"
        style="padding: 8px 12px; margin-right: 8px;">
        <svg id="icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-width="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
        <svg id="icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          style="display:none;">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
      </button>
      <button id="btn-my-submissions" class="btn primary" onclick="showMySubmissions()"
        style="display: flex; align-items: center; gap: 6px;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
          <polyline points="14 2 14 8 20 8" />
        </svg>
        My Submissions
        <span id="header-submission-count"
          style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem;">0</span>
      </button>
      <div class="user-badge">
        <div class="avatar" id="user-avatar">S</div>
        <span id="username-display">Student</span>
      </div>
      <button id="btn-logout" class="btn secondary">Log Out</button>
    </div>
  </header>

  <main class="container">
    <aside class="sidebar">
      <div class="sidebar-card">
        <div class="sidebar-header">
          <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>Problems</h3>
        </div>
        <ul id="problem-list" class="student-list">
          <li class="student-item" id="sidebar-item-1" onclick="selectProblem(1)">
            <div class="student-info">
              <div class="student-avatar">1</div>
              <div>
                <div class="student-name">Check Array is Sorted</div>
                <div class="student-meta">Data Structures - Day 1</div>
              </div>
            </div>
          </li>
          <li class="student-item" id="sidebar-item-2" onclick="selectProblem(2)">
            <div class="student-info">
              <div class="student-avatar">2</div>
              <div>
                <div class="student-name">Find Smallest Number Greater Than Key</div>
                <div class="student-meta">Data Structures - Day 1</div>
              </div>
            </div>
          </li>
          <li class="student-item" id="sidebar-item-3" onclick="selectProblem(3)">
            <div class="student-info">
              <div class="student-avatar">3</div>
              <div>
                <div class="student-name">Every Number Appears Twice Except One</div>
                <div class="student-meta">Data Structures - Day 1</div>
              </div>
            </div>
          </li>
          <li class="student-item" id="sidebar-item-4" onclick="selectProblem(4)">
            <div class="student-info">
              <div class="student-avatar">4</div>
              <div>
                <div class="student-name">Return Index of Element (Ignore First Occurrence)</div>
                <div class="student-meta">Data Structures - Day 1</div>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </aside>

    <section class="content">
      <!-- Welcome Banner -->
      <div id="student-welcome-banner" style="margin-bottom: 24px;">
        <h1 style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">
          Welcome back, <span id="welcome-student-name">Student</span>! ðŸ‘‹
        </h1>
        <p id="welcome-date" style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 16px;"></p>
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="panel"
        style="text-align: center; padding: 64px 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
        <div style="font-size: 3rem; margin-bottom: 24px; opacity: 0.5;">ðŸ‘ˆ</div>
        <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 12px;">Select a
          Problem</h2>
        <p style="color: var(--text-muted); max-width: 400px;">Please select a problem from the sidebar on the left to
          view the details and submit your solution.</p>
      </div>

      <!-- Problem Card 1 -->
      <div class="problem-card hidden" id="problem-card-1">
        <div class="problem-header">
          <h2><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 19.5A2.5 2.5 0 016.5 17H20" />
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z" />
            </svg> Data Structure - Day 1</h2>
          <h3>1. Check Array is Sorted</h3>
        </div>
        <div class="problem-body">
          <div id="problem-text">
            <div class="problem-section">
              <div class="problem-label">Problem Statement</div>
              <div class="problem-content">
                Check whether an array is sorted in ascending order.
              </div>
            </div>
            <div class="problem-section">
              <div class="problem-label">Input</div>
              <div class="problem-content">
                <code>arr = [2, 5, 8, 10]</code>
              </div>
            </div>
            <div class="problem-section">
              <div class="problem-label">Output</div>
              <div class="problem-content">
                <code>Sorted</code>
              </div>
            </div>
            <div class="problem-section">
              <div class="problem-label">Explanation</div>
              <div class="problem-content">
                Every element is smaller than the next one, indicating the array is sorted in ascending order.
              </div>
            </div>
            <div class="problem-section">
              <div class="problem-label">Requirements</div>
              <ul class="requirements-list">
                <li>Write a C function that checks if an array is sorted in ascending order</li>
                <li>Return 1 (true) if sorted, 0 (false) if not sorted</li>
                <li>Handle edge cases like empty arrays or single element arrays</li>
              </ul>
            </div>
          </div>
          <!-- File Upload Section -->
          <div class="upload-section">
            <form id="c-upload-form" class="upload-form">
              <div class="file-input-wrapper">
                <input type="file" id="cfile" name="cfile" accept=".c,.cpp,.java,.py,.txt" required />
                <div class="file-input-label">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z" />
                  </svg>
                  <span id="file-name">Choose a file</span>
                </div>
              </div>
              <button type="submit" class="btn primary" id="upload-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
                </svg> Submit Solution
              </button>
              <span id="upload-msg" class="upload-msg"></span>
            </form>
          </div>
          <!-- Loading Indicator, Success, Failed, Error Cards (reuse existing code) -->
          <div id="loading-indicator" class="loading-indicator hidden">
            <div class="spinner"></div>
            <span class="loading-text">Evaluating your solution...</span>
          </div>

        </div>
      </div>

      <!-- Problem Card 2 -->
      <div class="problem-card hidden" id="problem-card-2">
        <div class="problem-header">
          <h2><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 19.5A2.5 2.5 0 016.5 17H20" />
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z" />
            </svg> Data Structure - Day 1</h2>
          <h3>2. Find Smallest Number Greater Than Key</h3>
        </div>
        <div class="problem-body">
          <div id="problem-text-2">
            <div class="problem-section">
              <div class="problem-label">Problem Statement</div>
              <div class="problem-content">Find the smallest number in the array that is greater than the given key.
              </div>
            </div>
            <div class="problem-section">
              <div class="problem-label">Input</div>
              <div class="problem-content"><code>arr = [2, 4, 6, 8, 10]</code><br><code>key = 5</code></div>
            </div>
            <div class="problem-section">
              <div class="problem-label">Output</div>
              <div class="problem-content"><code>6</code></div>
            </div>
            <div class="problem-section">
              <div class="problem-label">Explanation</div>
              <div class="problem-content">Numbers greater than 5 â†’ 6, 8, 10. Smallest = 6</div>
            </div>
            <div class="problem-section">
              <div class="problem-label">Requirements</div>
              <ul class="requirements-list">
                <li>Write a C function to find the smallest number greater than a given key in an array</li>
                <li>Return -1 if no such number exists</li>
                <li>Assume the array is not necessarily sorted</li>
              </ul>
            </div>
          </div>
          <!-- File Upload Section -->
          <div class="upload-section">
            <form id="c-upload-form-2" class="upload-form">
              <div class="file-input-wrapper">
                <input type="file" id="cfile-2" name="cfile" accept=".c,.cpp,.java,.py,.txt" required />
                <div class="file-input-label">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z" />
                  </svg>
                  <span id="file-name-2">Choose a file</span>
                </div>
              </div>
              <button type="submit" class="btn primary" id="upload-btn-2">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
                </svg> Submit Solution
              </button>
              <span id="upload-msg-2" class="upload-msg"></span>
            </form>
          </div>
          <div id="loading-indicator-2" class="loading-indicator hidden">
            <div class="spinner"></div>
            <span class="loading-text">Evaluating your solution...</span>
          </div>

        </div>
      </div>

      <!-- Problem Card 3 -->
      <div class="problem-card hidden" id="problem-card-3">
        <div class="problem-header">
          <h2><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 19.5A2.5 2.5 0 016.5 17H20" />
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z" />
            </svg> Data Structure - Day 1</h2>
          <h3>3. Every Number Appears Twice Except One</h3>
        </div>
        <div class="problem-body">
          <div id="problem-text-3">
            <div class="problem-section">
              <div class="problem-label">Problem Statement</div>
              <div class="problem-content">Every number appears twice except one. Find it.</div>
            </div>
            <div class="problem-section">
              <div class="problem-label">Input</div>
              <div class="problem-content"><code>arr = [2, 3, 5, 3, 2]</code></div>
            </div>
            <div class="problem-section">
              <div class="problem-label">Output</div>
              <div class="problem-content"><code>5</code></div>
            </div>
            <div class="problem-section">
              <div class="problem-label">Explanation</div>
              <div class="problem-content">Pairs cancel each other. Only 5 appears once.</div>
            </div>
            <div class="problem-section">
              <div class="problem-label">Requirements</div>
              <ul class="requirements-list">
                <li>Write a C function to find the unique number in an array where every other number appears twice</li>
                <li>Use O(1) extra space and O(n) time</li>
              </ul>
            </div>
          </div>
          <!-- File Upload Section -->
          <div class="upload-section">
            <form id="c-upload-form-3" class="upload-form">
              <div class="file-input-wrapper">
                <input type="file" id="cfile-3" name="cfile" accept=".c,.cpp,.java,.py,.txt" required />
                <div class="file-input-label">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z" />
                  </svg>
                  <span id="file-name-3">Choose a file</span>
                </div>
              </div>
              <button type="submit" class="btn primary" id="upload-btn-3">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
                </svg> Submit Solution
              </button>
              <span id="upload-msg-3" class="upload-msg"></span>
            </form>
          </div>
          <div id="loading-indicator-3" class="loading-indicator hidden">
            <div class="spinner"></div>
            <span class="loading-text">Evaluating your solution...</span>
          </div>

        </div>
      </div>

      <!-- Problem Card 4 -->
      <div class="problem-card hidden" id="problem-card-4">
        <div class="problem-header">
          <h2><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 19.5A2.5 2.5 0 016.5 17H20" />
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z" />
            </svg> Data Structure - Day 1</h2>
          <h3>4. Return Index of Element (Ignore First Occurrence)</h3>
        </div>
        <div class="problem-body">
          <div id="problem-text-4">
            <div class="problem-section">
              <div class="problem-label">Problem Statement</div>
              <div class="problem-content">Return index of element, but ignore the first occurrence.</div>
            </div>
            <div class="problem-section">
              <div class="problem-label">Input</div>
              <div class="problem-content"><code>arr = [5, 3, 7, 3, 9]</code><br><code>key = 3</code></div>
            </div>
            <div class="problem-section">
              <div class="problem-label">Output</div>
              <div class="problem-content"><code>3</code></div>
            </div>
            <div class="problem-section">
              <div class="problem-label">Explanation</div>
              <div class="problem-content">First 3 at index 1 â†’ ignore. Second 3 at index 3 â†’ answer.</div>
            </div>
            <div class="problem-section">
              <div class="problem-label">Requirements</div>
              <ul class="requirements-list">
                <li>Write a C function to return the index of the second occurrence of a given key in an array</li>
                <li>Return -1 if the key does not occur at least twice</li>
              </ul>
            </div>
          </div>
          <!-- File Upload Section -->
          <div class="upload-section">
            <form id="c-upload-form-4" class="upload-form">
              <div class="file-input-wrapper">
                <input type="file" id="cfile-4" name="cfile" accept=".c,.cpp,.java,.py,.txt" required />
                <div class="file-input-label">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z" />
                  </svg>
                  <span id="file-name-4">Choose a file</span>
                </div>
              </div>
              <button type="submit" class="btn primary" id="upload-btn-4">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
                </svg> Submit Solution
              </button>
              <span id="upload-msg-4" class="upload-msg"></span>
            </form>
          </div>
          <div id="loading-indicator-4" class="loading-indicator hidden">
            <div class="spinner"></div>
            <span class="loading-text">Evaluating your solution...</span>
          </div>

        </div>
      </div>

      <!-- My Submissions Panel -->
      <div class="problem-card hidden" id="my-submissions-panel">
        <div class="problem-header">
          <h2><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
              <polyline points="14 2 14 8 20 8" />
            </svg> My Submissions</h2>
          <h3>Your Submission History</h3>
        </div>
        <div class="problem-body">
          <!-- Stats Row -->
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
            <div
              style="background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 12px; padding: 20px; color: white; text-align: center;">
              <div style="font-size: 2rem; font-weight: 700;" id="my-total-submissions">0</div>
              <div style="font-size: 0.875rem; opacity: 0.9;">Total Submissions</div>
            </div>
            <div
              style="background: linear-gradient(135deg, #22c55e, #16a34a); border-radius: 12px; padding: 20px; color: white; text-align: center;">
              <div style="font-size: 2rem; font-weight: 700;" id="my-accepted-count">0</div>
              <div style="font-size: 0.875rem; opacity: 0.9;">Accepted</div>
            </div>
            <div
              style="background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 12px; padding: 20px; color: white; text-align: center;">
              <div style="font-size: 2rem; font-weight: 700;" id="my-rejected-count">0</div>
              <div style="font-size: 0.875rem; opacity: 0.9;">Rejected</div>
            </div>
          </div>

          <!-- Submissions Table -->
          <div
            style="background: var(--bg-secondary); border-radius: 12px; overflow: hidden; max-height: 600px; overflow-y: auto;">
            <table class="data-table" style="width: 100%; border-collapse: collapse;">
              <thead style="position: sticky; top: 0; background: var(--bg-secondary); z-index: 5;">
                <tr>
                  <th>Problem</th>
                  <th>File</th>
                  <th>Status</th>
                  <th>Score</th>
                  <th>Submitted</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="my-submissions-table">
                <!-- Submissions will be loaded here -->
              </tbody>
            </table>
            <div id="no-my-submissions" class="hidden"
              style="padding: 40px; text-align: center; color: var(--text-muted);">
              <div style="font-size: 2rem; margin-bottom: 12px;">ðŸ“­</div>
              <p>You haven't submitted any solutions yet.</p>
              <p style="font-size: 0.875rem;">Select a problem from the sidebar and submit your code!</p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Submission Details Modal -->
  <div id="submission-modal" class="modal hidden">
    <div class="modal-card" style="max-width: 800px;">
      <div class="modal-header">
        <h3 style="display: flex; align-items: center; gap: 8px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
            <polyline points="14 2 14 8 20 8" />
            <line x1="16" y1="13" x2="8" y2="13" />
            <line x1="16" y1="17" x2="8" y2="17" />
            <polyline points="10 9 9 9 8 9" />
          </svg>
          Submission Details
        </h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="details-grid">
          <div class="detail-item">
            <label>Student</label>
            <div class="value" id="modal-student-name">-</div>
          </div>
          <div class="detail-item">
            <label>Problem</label>
            <div class="value" id="modal-problem-title">-</div>
          </div>
          <div class="detail-item">
            <label>Status</label>
            <div id="modal-status-badge">-</div>
          </div>
          <div class="detail-item">
            <label>Score</label>
            <div class="value score" id="modal-score">0/100</div>
          </div>
        </div>

        <div class="code-section">
          <div class="code-section-title">Submitted Code</div>
          <pre class="code-preview" id="modal-code-preview"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Get username from session and display
    let allowedExtensions = ['.c', '.cpp', '.java', '.py', '.txt'];
    let currentUserName = "Student";

    // Fetch allowed extensions
    fetch('/api/config/extensions')
      .then(res => res.json())
      .then(data => {
        if (data.extensions) {
          allowedExtensions = data.extensions.split(',').map(e => '.' + e.trim().replace(/^\./, '').toLowerCase());
          // Update existing inputs
          document.querySelectorAll('input[type="file"]').forEach(input => {
            input.accept = allowedExtensions.join(',');
          });
        }
      });

    // Set current date
    const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const dateElement = document.getElementById('welcome-date');
    if (dateElement) dateElement.textContent = new Date().toLocaleDateString('en-US', dateOptions);

    fetch('/get-user-info')
      .then(res => res.json())
      .then(data => {
        if (data.username) {
          currentUserName = data.username;
          document.getElementById('username-display').textContent = data.username;
          document.getElementById('user-avatar').textContent = data.username.charAt(0).toUpperCase();
          if (document.getElementById('welcome-student-name')) {
            document.getElementById('welcome-student-name').textContent = data.username;
          }
        }
      })
      .catch(() => { });

    // Load my submissions count on page load
    loadMySubmissionsCount();

    // Logout handler
    document.getElementById('btn-logout').onclick = function () {
      fetch('/logout').then(() => {
        window.location.href = '/login.html';
      });
    };

    function closeModal() {
      document.getElementById('submission-modal').classList.add('hidden');
    }

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    // Close modal when clicking outside
    document.getElementById('submission-modal').addEventListener('click', (e) => {
      if (e.target.id === 'submission-modal') closeModal();
    });

    // Helper function to create inline result message
    function showInlineResult(problemNum, status, score) {
      const loadingId = problemNum === 1 ? 'loading-indicator' : `loading-indicator-${problemNum}`;
      const loadingIndicator = document.getElementById(loadingId);

      // Create result message element
      const resultId = `submission-result-${problemNum}`;
      let resultDiv = document.getElementById(resultId);

      if (!resultDiv) {
        resultDiv = document.createElement('div');
        resultDiv.id = resultId;
        loadingIndicator.parentNode.insertBefore(resultDiv, loadingIndicator.nextSibling);
      }

      if (status === 'accepted') {
        resultDiv.innerHTML = `
          <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f0fdf4, #dcfce7); border: 2px solid #22c55e; border-radius: 12px; animation: fadeIn 0.3s ease;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="width: 48px; height: 48px; background: #22c55e; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </div>
              <div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #166534;">âœ“ FILE ACCEPTED</div>
                <div style="color: #15803d; font-size: 0.875rem;">Your solution has been submitted successfully!</div>
              </div>
            </div>
            <div style="display: flex; gap: 16px; padding-top: 12px; border-top: 1px solid #bbf7d0;">
              <div style="flex: 1; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #166534;">${score}/100</div>
                <div style="font-size: 0.75rem; color: #15803d;">Score</div>
              </div>
              <div style="flex: 1; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #166534;">âœ“</div>
                <div style="font-size: 0.75rem; color: #15803d;">Status</div>
              </div>
            </div>
          </div>
        `;
      } else {
        resultDiv.innerHTML = `
          <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #fef2f2, #fee2e2); border: 2px solid #ef4444; border-radius: 12px; animation: fadeIn 0.3s ease;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="width: 48px; height: 48px; background: #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </div>
              <div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #991b1b;">âœ— FILE REJECTED</div>
                <div style="color: #b91c1c; font-size: 0.875rem;">Your solution did not pass the evaluation.</div>
              </div>
            </div>
            <div style="display: flex; gap: 16px; padding-top: 12px; border-top: 1px solid #fecaca;">
              <div style="flex: 1; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #991b1b;">${score}/100</div>
                <div style="font-size: 0.75rem; color: #b91c1c;">Score</div>
              </div>
              <div style="flex: 1; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #991b1b;">âœ—</div>
                <div style="font-size: 0.75rem; color: #b91c1c;">Status</div>
              </div>
            </div>
          </div>
        `;
      }

      // Auto-hide after 10 seconds
      setTimeout(() => {
        if (resultDiv) {
          resultDiv.style.opacity = '0';
          resultDiv.style.transition = 'opacity 0.3s ease';
          setTimeout(() => resultDiv.remove(), 300);
        }
      }, 10000);

      // Refresh my submissions count
      loadMySubmissionsCount();
    }

    // Helper to set up upload logic for each problem
    function setupUpload(problemNum) {
      const formId = problemNum === 1 ? 'c-upload-form' : `c-upload-form-${problemNum}`;
      const fileId = problemNum === 1 ? 'cfile' : `cfile-${problemNum}`;
      const fileNameId = problemNum === 1 ? 'file-name' : `file-name-${problemNum}`;
      const uploadBtnId = problemNum === 1 ? 'upload-btn' : `upload-btn-${problemNum}`;
      const uploadMsgId = problemNum === 1 ? 'upload-msg' : `upload-msg-${problemNum}`;
      const loadingId = problemNum === 1 ? 'loading-indicator' : `loading-indicator-${problemNum}`;
      const problemTextId = problemNum === 1 ? 'problem-text' : `problem-text-${problemNum}`;

      const fileInput = document.getElementById(fileId);
      const fileNameSpan = document.getElementById(fileNameId);
      const uploadBtn = document.getElementById(uploadBtnId);
      const msg = document.getElementById(uploadMsgId);
      const loadingIndicator = document.getElementById(loadingId);

      if (!fileInput) return;

      fileInput.addEventListener('change', function () {
        const fileName = this.files[0] ? this.files[0].name : 'Choose a file';
        fileNameSpan.textContent = fileName;
        // Clear any previous result message
        const resultDiv = document.getElementById(`submission-result-${problemNum}`);
        if (resultDiv) resultDiv.remove();
      });

      document.getElementById(formId).onsubmit = async function (e) {
        e.preventDefault();
        msg.textContent = '';
        msg.className = 'upload-msg';

        // Clear previous result
        const existingResult = document.getElementById(`submission-result-${problemNum}`);
        if (existingResult) existingResult.remove();

        if (!fileInput.files.length) {
          msg.textContent = 'Please select a file.';
          msg.className = 'upload-msg error';
          return;
        }

        const file = fileInput.files[0];
        // Dynamic validation
        const ext = '.' + file.name.split('.').pop().toLowerCase();
        if (!allowedExtensions.includes(ext)) {
          msg.textContent = 'Allowed files: ' + allowedExtensions.join(', ');
          msg.className = 'upload-msg error';
          return;
        }

        // Read file content for preview
        const fileContent = await file.text();

        // Extract the problem statement from the page
        const problemTitle = this.closest('.problem-card').querySelector('.problem-header h3').textContent;
        const problemTextElement = document.getElementById(problemTextId);
        const problemStatement = `${problemTitle}\n\n${problemTextElement.innerText}`;

        // Show loading state
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Evaluating...';
        loadingIndicator.classList.remove('hidden');

        const formData = new FormData();
        formData.append('cfile', file);
        formData.append('problem', problemStatement);

        try {
          const response = await fetch('/upload-c', {
            method: 'POST',
            body: formData,
          });
          const result = await response.json();

          if (result.success) {
            // Show inline result message instead of modal
            showInlineResult(problemNum, result.status, result.score);
          } else {
            msg.textContent = result.message || 'Upload failed.';
            msg.className = 'upload-msg error';
          }
        } catch (err) {
          msg.textContent = 'Error connecting to server.';
          msg.className = 'upload-msg error';
        } finally {
          uploadBtn.disabled = false;
          uploadBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg> Submit Solution';
          loadingIndicator.classList.add('hidden');
          fileInput.value = '';
          fileNameSpan.textContent = 'Choose a file';
        }
      };
    }

    // Setup upload for all 4 problems
    [1, 2, 3, 4].forEach(setupUpload);

    // Problem Selection Logic
    // Problem Selection Logic
    function selectProblem(id) {
      // Hide empty state
      document.getElementById('empty-state').classList.add('hidden');

      // Hide all problem cards including my-submissions-panel
      const cards = document.querySelectorAll('.problem-card');
      cards.forEach(card => card.classList.add('hidden'));

      // Show selected card
      const selectedCard = document.getElementById(`problem-card-${id}`);
      if (selectedCard) {
        selectedCard.classList.remove('hidden');
      }

      // Update sidebar active state
      const items = document.querySelectorAll('.student-item, .sidebar-item');
      items.forEach(item => item.classList.remove('active'));

      const selectedItem = document.getElementById(`sidebar-item-${id}`);
      if (selectedItem) {
        selectedItem.classList.add('active');
      }
    }

    // =============================================
    // My Submissions Functions
    // =============================================

    async function loadMySubmissionsCount() {
      try {
        const res = await fetch('/api/student/my-submissions');
        const submissions = await res.json();
        const count = submissions.length;
        const accepted = submissions.filter(s => s.status === 'accepted').length;
        // Update header badge count only (sidebar was removed)
        document.getElementById('header-submission-count').textContent = count;
      } catch (err) {
        document.getElementById('header-submission-count').textContent = '0';
      }
    }

    async function showMySubmissions() {
      // Hide empty state
      document.getElementById('empty-state').classList.add('hidden');

      // Hide all problem cards
      const cards = document.querySelectorAll('.problem-card');
      cards.forEach(card => card.classList.add('hidden'));

      // Show my submissions panel
      document.getElementById('my-submissions-panel').classList.remove('hidden');

      // Update sidebar active state (remove active from problem items)
      const items = document.querySelectorAll('.student-item');
      items.forEach(item => item.classList.remove('active'));

      // Load submissions
      try {
        const res = await fetch('/api/student/my-submissions');
        const submissions = await res.json();

        // Update stats
        document.getElementById('my-total-submissions').textContent = submissions.length;
        const accepted = submissions.filter(s => s.status === 'accepted').length;
        const rejected = submissions.filter(s => s.status === 'rejected').length;
        document.getElementById('my-accepted-count').textContent = accepted;
        document.getElementById('my-rejected-count').textContent = rejected;

        // Update table
        const tbody = document.getElementById('my-submissions-table');
        const noSubmissions = document.getElementById('no-my-submissions');

        if (submissions.length === 0) {
          tbody.innerHTML = '';
          noSubmissions.classList.remove('hidden');
        } else {
          noSubmissions.classList.add('hidden');
          tbody.innerHTML = submissions.map(s => `
            <tr>
              <td style="font-weight: 500;">${s.problem_title || 'N/A'}</td>
              <td>${s.filename}</td>
              <td>
                <span class="status-badge ${s.status === 'accepted' ? 'success' : 'failed'}">
                  ${s.status === 'accepted' ? 'âœ“ Accepted' : 'âœ— Rejected'}
                </span>
              </td>
              <td style="font-weight: 600;">${s.score || 0}/100</td>
              <td>${formatDate(s.submitted_at)}</td>
              <td>
                <button class="btn secondary" style="padding: 6px 12px; font-size: 0.75rem;" onclick="viewMySubmission(${s.id})">
                  View Details
                </button>
              </td>
            </tr>
          `).join('');
        }
      } catch (err) {
        console.error('Error loading submissions:', err);
      }
    }

    async function viewMySubmission(id) {
      try {
        const res = await fetch(`/api/student/submission/${id}`);
        const sub = await res.json();

        document.getElementById('modal-student-name').textContent = currentUserName;
        document.getElementById('modal-problem-title').textContent = sub.problem_title || 'N/A';
        document.getElementById('modal-score').textContent = `${sub.score || 0}/100`;
        document.getElementById('modal-code-preview').textContent = sub.file_content || 'No code available';

        const badge = document.getElementById('modal-status-badge');
        if (sub.status === 'accepted') {
          badge.innerHTML = '<span class="status-badge success">âœ“ ACCEPTED</span>';
        } else {
          badge.innerHTML = '<span class="status-badge failed">âœ— REJECTED</span>';
        }

        document.getElementById('submission-modal').classList.remove('hidden');
      } catch (err) {
        console.error('Error loading submission details:', err);
        alert('Failed to load submission details');
      }
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      const date = new Date(dateStr);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // =============================================
    // Dynamic Question Loading
    // =============================================

    async function loadDynamicQuestions() {
      try {
        const res = await fetch('/api/questions/active');

        if (!res.ok) {
          console.error('Failed to fetch questions:', res.status, res.statusText);
          return;
        }

        const questions = await res.json();

        if (!questions || questions.length === 0) {
          return;
        }

        const problemList = document.getElementById('problem-list');
        const contentSection = document.querySelector('.content');

        // Start ID from 5 (after the 4 hardcoded questions)
        let questionId = 5;

        questions.forEach(q => {
          const currentId = questionId; // Capture current ID

          // Add to sidebar
          const sidebarItem = document.createElement('li');
          sidebarItem.className = 'student-item';
          sidebarItem.id = `sidebar-item-${currentId}`;
          sidebarItem.onclick = () => {
            selectProblem(currentId);
          };
          sidebarItem.innerHTML = `
            <div class="student-info">
              <div class="student-avatar">${currentId}</div>
              <div>
                <div class="student-name">${q.title}</div>
                <div class="student-meta">${q.difficulty || 'Medium'} - Added by Admin</div>
              </div>
            </div>
          `;
          problemList.appendChild(sidebarItem);

          // Helper function to format the description into styled sections
          function formatDescription(desc) {
            if (!desc) return '';

            let html = '';

            // 1. Problem Statement
            const inputMatch = desc.match(/(?:Input|Sample Input):/i);
            const statementEnd = inputMatch ? inputMatch.index : desc.length;
            const statement = desc.substring(0, statementEnd).trim();

            html += `
              <div class="problem-section">
                <div class="problem-label">Problem Statement</div>
                <div class="problem-content" style="white-space: pre-wrap;">${statement || desc}</div>
              </div>
            `;

            // Helper to safe-trim
            const safeTrim = (str) => str ? str.trim() : '';

            // 2. Extract Input (Description only)
            const inputRegex = /Input:\s*([\s\S]*?)(?=(?:Sample Input|Output|Sample Output|Explanation|Requirements|Difficulty):|$)/i;
            const inputRes = desc.match(inputRegex);
            if (inputRes && safeTrim(inputRes[1])) {
              html += `
                <div class="problem-section">
                  <div class="problem-label">Input</div>
                  <div class="problem-content">${inputRes[1].trim()}</div>
                </div>`;
            }

            // 3. Extract Sample Input (Code block)
            const sampleInputRegex = /Sample Input:\s*([\s\S]*?)(?=(?:Input|Output|Sample Output|Explanation|Requirements|Difficulty):|$)/i;
            const sampleInputRes = desc.match(sampleInputRegex);
            if (sampleInputRes && safeTrim(sampleInputRes[1])) {
              html += `
                <div class="problem-section">
                  <div class="problem-label">Sample Input</div>
                  <div class="problem-content">
                    <code>${sampleInputRes[1].trim()}</code>
                  </div>
                </div>`;
            }

            // 4. Extract Output (Description only)
            const outputRegex = /Output:\s*([\s\S]*?)(?=(?:Sample Input|Sample Output|Input|Explanation|Requirements|Difficulty):|$)/i;
            const outputRes = desc.match(outputRegex);
            if (outputRes && safeTrim(outputRes[1])) {
              html += `
                <div class="problem-section">
                  <div class="problem-label">Output</div>
                  <div class="problem-content">${outputRes[1].trim()}</div>
                </div>`;
            }

            // 5. Extract Sample Output (Code block)
            const sampleOutputRegex = /Sample Output:\s*([\s\S]*?)(?=(?:Input|Output|Sample Input|Explanation|Requirements|Difficulty):|$)/i;
            const sampleOutputRes = desc.match(sampleOutputRegex);
            if (sampleOutputRes && safeTrim(sampleOutputRes[1])) {
              html += `
                <div class="problem-section">
                  <div class="problem-label">Sample Output</div>
                  <div class="problem-content">
                    <code>${sampleOutputRes[1].trim()}</code>
                  </div>
                </div>`;
            }

            // 6. Explanation
            const explainRegex = /Explanation:\s*([\s\S]*?)(?=(?:Requirements|Difficulty):|$)/i;
            const explainRes = desc.match(explainRegex);
            if (explainRes && safeTrim(explainRes[1])) {
              html += `
                <div class="problem-section">
                  <div class="problem-label">Explanation</div>
                  <div class="problem-content">${explainRes[1].trim()}</div>
                </div>
              `;
            }

            return html;
          }

          // Create problem card
          const problemCard = document.createElement('div');
          problemCard.className = 'problem-card hidden';
          problemCard.id = `problem-card-${currentId}`;

          problemCard.innerHTML = `
            <div class="problem-header" style="margin-bottom: 24px;">
              <div style="font-size: 0.85rem; color: var(--text-muted); font-weight: 500; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; text-transform: uppercase; letter-spacing: 0.05em;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <path d="M4 19.5A2.5 2.5 0 016.5 17H20" />
                   <path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z" />
                </svg>
                ${q.difficulty || 'Medium'} â€¢ Added by Admin
              </div>
              <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin: 0; line-height: 1.3;">
                ${currentId}. ${q.title}
              </h2>
            </div>
            <div class="problem-body">
              <div id="problem-text-${currentId}">
                ${formatDescription(q.description)}
              </div>
              <div class="upload-section" style="margin-top: 32px; border-top: 1px solid var(--border-color); padding-top: 24px;">
                <h4 style="margin-bottom: 20px; color: var(--text-primary); font-weight: 600; font-size: 1.1rem;">Submit Your Solution</h4>
                
                <form id="c-upload-form-${currentId}" class="upload-form" enctype="multipart/form-data" style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                  <div class="file-upload-wrapper">
                    <label for="cfile-${currentId}" class="file-upload-label" style="background: var(--bg-tertiary); border: 2px dashed var(--border-color); padding: 12px 24px; border-radius: 8px; font-weight: 500; color: var(--text-secondary); display: flex; align-items: center; gap: 10px; cursor: pointer; transition: all 0.2s;">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z" />
                        <polyline points="13 2 13 9 20 9" />
                      </svg>
                      <span id="file-name-${currentId}">Choose a file</span>
                    </label>
                    <input type="file" id="cfile-${currentId}" name="cfile" accept=".c,.cpp,.java,.py,.txt" required style="display: none;" />
                  </div>
                  <button type="submit" class="btn primary" id="upload-btn-${currentId}" style="padding: 12px 24px; font-size: 0.95rem;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="22" y1="2" x2="11" y2="13"></line>
                      <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                    Submit Solution
                  </button>
                  <span id="upload-msg-${currentId}" class="upload-msg"></span>
                </form>
              </div>
              <div id="loading-indicator-${currentId}" class="loading-indicator hidden">
                <div class="spinner"></div>
                <span class="loading-text">Evaluating your solution...</span>
              </div>
            </div>
          `;

          // Insert before My Submissions panel
          const mySubmissionsPanel = document.getElementById('my-submissions-panel');
          if (mySubmissionsPanel) {
            contentSection.insertBefore(problemCard, mySubmissionsPanel);
          } else {
            // If my-submissions-panel doesn't exist, just append
            contentSection.appendChild(problemCard);
          }

          // Setup upload for this form
          setupUpload(currentId);

          // Inject Monaco Editor immediately
          setTimeout(() => injectMonaco(currentId), 0);

          // Increment question ID for next question
          questionId++;
        });
      } catch (err) {
        console.error('Error loading dynamic questions:', err);
      }
    }

    // Load dynamic questions on page load
    loadDynamicQuestions();

    // =============================================
    // MONACO EDITOR INTEGRATION
    // =============================================
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' } });

    // Global editor instances
    const editors = {};

    function injectMonaco(id) {
      const card = document.getElementById(`problem-card-${id}`);
      if (!card) return;

      const uploadSection = card.querySelector('.upload-section');
      if (!uploadSection || uploadSection.classList.contains('monaco-injected')) return;

      uploadSection.classList.add('monaco-injected');

      // Create Container Stucture
      const container = document.createElement('div');
      container.innerHTML = `
            <div class="submission-toggle">
                <button class="toggle-btn active" onclick="switchMode(${id}, 'upload')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: text-bottom; margin-right: 4px;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                    Upload File
                </button>
                <button class="toggle-btn" onclick="switchMode(${id}, 'editor')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: text-bottom; margin-right: 4px;"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
                    Code Editor
                </button>
            </div>

            <!-- Existing Upload Form Wrapper -->
            <div id="mode-upload-${id}" class="editor-container-box active">
                <!-- Form will be moved here -->
            </div>

            <!-- New Editor Wrapper -->
            <div id="mode-editor-${id}" class="editor-container-box">
                <div style="margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;">
                    <select id="lang-select-${id}" class="form-input" style="width: 150px; padding: 6px;" onchange="changeLanguage(${id})">
                        <option value="c">C</option>
                        <option value="cpp">C++</option>
                        <option value="python">Python</option>
                        <option value="java">Java</option>
                    </select>
                    
                    <div style="display: flex; gap: 8px;">
                        <button class="btn secondary" style="padding: 4px 8px; font-size: 0.8rem;" onclick="formatCode(${id})" title="Auto Format">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10H3"/><path d="M21 6H3"/><path d="M21 14H3"/><path d="M21 18H3"/></svg>
                        </button>
                         <button class="btn secondary" style="padding: 4px 8px; font-size: 0.8rem;" onclick="resetCode(${id})" title="Reset Code">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                        </button>
                        <button class="btn secondary" style="padding: 4px 8px; font-size: 0.8rem;" onclick="downloadCode(${id})" title="Download File">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        </button>
                    </div>
                </div>
                <div id="monaco-container-${id}" class="monaco-wrapper"></div>
                
                <button class="btn primary" onclick="submitCode(${id})" style="margin-top: 16px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg> 
                    Run & Submit Code
                </button>
                <div id="editor-msg-${id}" class="upload-msg" style="margin-top: 10px;"></div>
            </div>
        `;

      // Move existing form into the upload container
      const existingForm = card.querySelector('form');
      const modeUpload = container.querySelector(`#mode-upload-${id}`);
      // We clone or move? Moving is better to keep listeners.
      if (existingForm) {
        existingForm.parentNode.insertBefore(container, existingForm);
        modeUpload.appendChild(existingForm);
      } else {
        uploadSection.appendChild(container);
      }
    }

    function switchMode(id, mode) {
      // Toggle Buttons
      const card = document.getElementById(`problem-card-${id}`);
      const btns = card.querySelectorAll('.toggle-btn');
      btns[0].classList.toggle('active', mode === 'upload');
      btns[1].classList.toggle('active', mode === 'editor');

      // Toggle Content
      document.getElementById(`mode-upload-${id}`).classList.toggle('active', mode === 'upload');
      document.getElementById(`mode-editor-${id}`).classList.toggle('active', mode === 'editor');

      if (mode === 'editor') {
        initEditorInstance(id);
      }
    }

    // Boilerplate templates
    const boilerplates = {
      'c': '#include <stdio.h>\n\nint main() {\n    // Write your solution here\n    printf("Hello World");\n    return 0;\n}',
      'cpp': '#include <iostream>\nusing namespace std;\n\nint main() {\n    // Write your solution here\n    cout << "Hello World";\n    return 0;\n}',
      'java': 'public class Main {\n    public static void main(String[] args) {\n        // Write your solution here\n        System.out.println("Hello World");\n    }\n}',
      'python': '# Write your solution here\ndef solve():\n    print("Hello World")\n\nif __name__ == "__main__":\n    solve()'
    };

    function initEditorInstance(id) {
      if (editors[id]) return; // Already initialized

      require(['vs/editor/editor.main'], function () {
        const el = document.getElementById(`monaco-container-${id}`);
        if (!el) return;

        const defaultLang = 'c';
        const editor = monaco.editor.create(el, {
          value: boilerplates[defaultLang],
          language: defaultLang,
          theme: 'vs-dark', // Pro Dark Theme
          minimap: { enabled: true },
          automaticLayout: true,
          fontSize: 14,
          fontFamily: "'JetBrains Mono', 'Consolas', monospace",
          scrollBeyondLastLine: false,
          padding: { top: 16, bottom: 16 },
          contextmenu: false // Disable Right Click Menu
        });

        // Anti-Cheat: Disable Paste
        editor.onKeyDown((e) => {
          // Only block if configured by Admin
          if (!window.appConfig.block_paste) return;

          // Check for Ctrl+V or Cmd+V
          if ((e.ctrlKey || e.metaKey) && (e.code === 'KeyV' || e.keyCode === 52)) {
            e.preventDefault();
            e.stopPropagation();
            // Show warning in the message area
            const msg = document.getElementById(`editor-msg-${id}`);
            if (msg) {
              msg.textContent = 'âš ï¸ Anti-Cheat: Pasting is disabled!';
              msg.className = 'upload-msg error';
              setTimeout(() => msg.textContent = '', 2000);
            }
          }
        });

        editors[id] = editor;
      });
    }

    function changeLanguage(id) {
      const lang = document.getElementById(`lang-select-${id}`).value;
      const editor = editors[id];
      if (!editor) return;

      const model = editor.getModel();
      monaco.editor.setModelLanguage(model, lang === 'c' || lang === 'cpp' ? 'cpp' : lang);

      // Update boilerplate code
      // We only update if the current code is empty or matches one of the other boilerplates (to avoid overwriting user work)
      const currentVal = editor.getValue();
      const isBoilerplate = Object.values(boilerplates).some(b => b === currentVal) || currentVal.trim() === '';

      if (isBoilerplate) {
        editor.setValue(boilerplates[lang]);
      }
    }

    function formatCode(id) {
      const editor = editors[id];
      if (editor) editor.trigger('anyString', 'editor.action.formatDocument');
    }

    function resetCode(id) {
      if (!confirm('Reset code to default template? This will clear your changes.')) return;
      const lang = document.getElementById(`lang-select-${id}`).value;
      const editor = editors[id];
      if (editor && boilerplates[lang]) editor.setValue(boilerplates[lang]);
    }

    function downloadCode(id) {
      const editor = editors[id];
      if (!editor) return;
      const content = editor.getValue();
      const lang = document.getElementById(`lang-select-${id}`).value;
      const extMap = { 'c': '.c', 'cpp': '.cpp', 'python': '.py', 'java': '.java' };

      const blob = new Blob([content], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `solution${extMap[lang]}`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    async function submitCode(id) {
      const editor = editors[id];
      if (!editor) return;

      const content = editor.getValue();
      const lang = document.getElementById(`lang-select-${id}`).value;
      const extMap = { 'c': '.c', 'cpp': '.cpp', 'python': '.py', 'java': '.java' };
      const filename = `solution${extMap[lang]}`;

      // UI Feedback
      const msg = document.getElementById(`editor-msg-${id}`);
      const loadingIndicator = document.getElementById(`loading-indicator-${id}`) || document.getElementById('loading-indicator'); // Fallback for id 1

      msg.textContent = '';
      if (loadingIndicator) loadingIndicator.classList.remove('hidden');

      try {
        // Create File from content
        const file = new File([content], filename, { type: "text/plain" });
        const formData = new FormData();
        formData.append('cfile', file);

        // Add problem context
        const card = document.getElementById(`problem-card-${id}`);
        const titleEl = card.querySelector('.problem-header h3');
        const problemStatement = titleEl ? titleEl.innerText : 'Check Array is Sorted';
        formData.append('problem', problemStatement);

        // Correct Endpoint to match server.py
        const res = await fetch('/upload-c', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (data.success) {
          msg.textContent = 'âœ“ Solution Submitted Successfully!';
          msg.className = 'upload-msg success';

          // Refresh submissions
          if (window.showMySubmissions) showMySubmissions();
          if (window.loadMySubmissionsCount) loadMySubmissionsCount();
        } else {
          msg.textContent = 'âœ— ' + data.message;
          msg.className = 'upload-msg error';
        }

      } catch (e) {
        console.error(e);
        msg.textContent = 'Error sending code.';
        msg.className = 'upload-msg error';
      } finally {
        if (loadingIndicator) loadingIndicator.classList.add('hidden');
      }
    }

    // Initialize Monaco for hardcoded problems
    [1, 2, 3, 4].forEach(id => {
      // Wait for DOM
      setTimeout(() => injectMonaco(id), 100);
    });

    // Hook into loadDynamicQuestions to initialize new ones
    const originalLoadDynamic = loadDynamicQuestions;
    loadDynamicQuestions = async function () {
      await originalLoadDynamic(); // Run original
      // Initialize Monaco for any new cards found
      // We know dynamic starts at 5. Let's just find all problem-cards.
      document.querySelectorAll('.problem-card').forEach(card => {
        const id = parseInt(card.id.replace('problem-card-', ''));
        if (id >= 5) injectMonaco(id);
      });
    };

    // ============================================
    // Theme Manager
    // ============================================
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    // Defer icon update until DOM loaded (or call immediately if safe)
    if (document.body) updateThemeIcon(savedTheme);
    else document.addEventListener('DOMContentLoaded', () => updateThemeIcon(savedTheme));

    function toggleTheme() {
      const html = document.documentElement;
      const isDark = html.getAttribute('data-theme') === 'dark';
      const newTheme = isDark ? 'light' : 'dark';

      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);

      // Update all editors
      if (window.monaco) {
        monaco.editor.setTheme(newTheme === 'dark' ? 'vs-dark' : 'vs-light');
      }
    }

    function updateThemeIcon(theme) {
      const moon = document.getElementById('icon-moon');
      const sun = document.getElementById('icon-sun');
      if (!moon || !sun) return;

      if (theme === 'dark') {
        moon.style.display = 'none';
        sun.style.display = 'block';
      } else {
        moon.style.display = 'block';
        sun.style.display = 'none';
      }
    }
  </script>
</body>

</html>